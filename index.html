<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RecycleBuddy: Live Classification Demo</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TensorFlow + MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }

        #webcam-container {
            position: relative; width: 100%; max-width: 500px;
            margin: 0 auto; border-radius: 1.5rem; overflow: hidden;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            aspect-ratio: 4/3; background-color: #000;
        }

        video, canvas {
            width: 100%; height: 100%; object-fit: cover;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen p-4 flex flex-col items-center text-white">
    <div class="w-full max-w-xl text-center">
        <h1 class="text-4xl font-extrabold text-green-400 mt-4 mb-2">RecycleBuddy ‚ôªÔ∏è</h1>
        <p class="text-gray-300 mb-6">live ai classification (demo + real model)</p>
    </div>

    <!-- MODEL TOGGLE -->
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4 w-full max-w-xl text-center">
        <label class="text-lg font-semibold">Choose Model:</label>
        <select id="model-select"
                class="mt-2 p-3 bg-gray-700 rounded-lg w-full font-bold text-white text-center border border-gray-600">
            <option value="demo">Demo Model (MobileNet) ‚Äî Recommended</option>
            <option value="real">Real RecycleBuddy Model (TFJS)</option>
        </select>
    </div>

    <!-- webcam -->
    <div id="webcam-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <!-- status -->
    <div id="status-message"
        class="mt-4 p-3 rounded-xl w-full max-w-xl text-center text-lg font-semibold bg-gray-700 text-gray-200 shadow-xl">
        select model above, then wait for model to load.
    </div>

    <!-- result -->
    <div id="result-display"
        class="mt-4 p-6 text-4xl font-bold rounded-xl w-full max-w-xl shadow-2xl bg-gray-800 text-center">
        <span class="text-xl">Point your camera at an item üì∏</span>
    </div>

    <!-- start button -->
    <div class="w-full max-w-xl text-center mt-6">
        <button id="start-button"
            class="px-8 py-4 bg-green-500 text-white text-2xl font-bold rounded-full hover:bg-green-600 hidden">
            start live scan
        </button>
    </div>

<script>
    let model;
    let webcam;
    let isPredicting = false;

    const REAL_MODEL_URL = "./tfjs_model_artifacts/model.json"; // your real model
    const statusEl = document.getElementById("status-message");
    const resultEl = document.getElementById("result-display");
    const startButton = document.getElementById("start-button");
    const modelSelect = document.getElementById("model-select");

    // Load the selected model
    async function loadSelectedModel() {
        const choice = modelSelect.value;
        isPredicting = false;
        startButton.classList.add("hidden");
        resultEl.textContent = "Point your camera at an item üì∏";

        if (choice === "demo") {
            await loadDemoModel();
        } else {
            await loadRealModel();
        }
    }

    // DEMO: MobileNet model
    async function loadDemoModel() {
        try {
            statusEl.textContent = "Loading MobileNet (demo)‚Ä¶";

            model = await mobilenet.load({ version: 2, alpha: 1.0 });

            statusEl.textContent = "MobileNet loaded! Tap start.";
            startButton.classList.remove("hidden");
        } catch (err) {
            statusEl.textContent = "Failed to load MobileNet.";
            console.error(err);
        }
    }

    // REAL: Load your TFJS RecycleBuddy model
    async function loadRealModel() {
        try {
            statusEl.textContent = "Loading RecycleBuddy Model‚Ä¶";

            model = await tf.loadLayersModel(REAL_MODEL_URL);

            statusEl.textContent = "RecycleBuddy Model loaded! Tap start.";
            startButton.classList.remove("hidden");

        } catch (error) {
            statusEl.textContent = "Real model FAILED to load.";
            console.error("Real model error:", error);
        }
    }

    // Webcam setup
    async function setupWebcam() {
        const cam = document.getElementById("webcam");

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });

            cam.srcObject = stream;
            return new Promise(resolve => {
                cam.onloadedmetadata = () => {
                    cam.play();
                    resolve(true);
                };
            });
        } catch (err) {
            statusEl.textContent = "Camera unavailable.";
            console.error(err);
            return false;
        }
    }

    // Map MobileNet predictions ‚Üí Recyclable / Non Recyclable
    function mapRecycle(pred) {
        const recyclable = ["bottle", "plastic", "paper", "cardboard", "metal", "can", "cup"];
        const label = pred.className.toLowerCase();

        for (let item of recyclable) {
            if (label.includes(item)) {
                return { tag: "‚ôªÔ∏è RECYCLABLE", color: "bg-green-600" };
            }
        }
        return { tag: "üóëÔ∏è NON-RECYCLABLE", color: "bg-red-600" };
    }

    // Prediction loop (handles BOTH models automatically)
    async function predict() {
        if (!isPredicting) return;

        const modelType = modelSelect.value;

        if (modelType === "demo") {
            const predictions = await model.classify(webcam);

            if (predictions.length > 0) {
                const mapped = mapRecycle(predictions[0]);
                resultEl.textContent = `${mapped.tag} (${predictions[0].className})`;
                resultEl.className =
                    `mt-4 p-6 text-4xl font-bold rounded-xl w-full max-w-xl text-center text-white shadow-xl ${mapped.color}`;
            }
        } else {
            // REAL MODEL PREDICTION
            const input = tf.tidy(() => {
                let t = tf.browser.fromPixels(webcam);
                t = tf.image.resizeBilinear(t, [224, 224]);
                t = t.div(255).expandDims(0);
                return t;
            });

            const pred = model.predict(input);
            const values = pred.dataSync();
            const classId = values.indexOf(Math.max(...values));
            const label = classId === 0 ? "‚ôªÔ∏è RECYCLABLE" : "üóëÔ∏è NON-RECYCLABLE";
            const color = classId === 0 ? "bg-green-600" : "bg-red-600";

            resultEl.textContent = `${label}`;
            resultEl.className =
                `mt-4 p-6 text-4xl font-bold rounded-xl w-full max-w-xl text-center text-white shadow-xl ${color}`;

            tf.dispose(input);
        }

        requestAnimationFrame(predict);
    }

    startButton.addEventListener("click", () => {
        isPredicting = true;
        startButton.classList.add("hidden");
        statusEl.textContent = "Scanning‚Ä¶";
        predict();
    });

    modelSelect.addEventListener("change", loadSelectedModel);

    window.onload = async () => {
        await setupWebcam();
        statusEl.textContent = "Select a model above to begin.";
    };
</script>
</body>
</html>